name: Documentation Validation

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.md'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - '**.md'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  markdown-lint:
    name: Markdown Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          markdownlint '**/*.md' --ignore node_modules --ignore frontend/node_modules || echo "‚ö†Ô∏è  Markdown linting issues found"

  link-checker:
    name: Check Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Link Checker
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress '**/*.md' '**/*.html'
          fail: false  # Don't fail on broken links, just report

      - name: Create Issue on Broken Links
        if: env.lychee_exit_code != 0
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîó Broken links detected in documentation',
              body: 'The link checker found broken links. Please review the workflow logs and fix them.\n\nWorkflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}',
              labels: ['documentation', 'bug']
            })

  check-readme:
    name: Validate README
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "‚ùå README.md not found!"
            exit 1
          fi
          echo "‚úÖ README.md exists"

      - name: Check README has minimum content
        run: |
          # Check for essential sections
          sections=(
            "Overview"
            "Quick Start"
            "Installation"
            "Documentation"
            "License"
          )

          missing_sections=()
          for section in "${sections[@]}"; do
            if ! grep -qi "$section" README.md; then
              missing_sections+=("$section")
            fi
          done

          if [ ${#missing_sections[@]} -gt 0 ]; then
            echo "‚ö†Ô∏è  README.md missing recommended sections:"
            printf '%s\n' "${missing_sections[@]}"
          else
            echo "‚úÖ README.md has all recommended sections"
          fi

      - name: Check for broken image references
        run: |
          echo "Checking for broken image references in README..."
          # Extract image paths from markdown
          images=$(grep -oP '!\[.*?\]\(\K[^)]+' README.md || true)

          if [ -n "$images" ]; then
            echo "Found images:"
            echo "$images"
            # Check if local images exist
            while IFS= read -r img; do
              if [[ ! "$img" =~ ^https?:// ]]; then
                if [ ! -f "$img" ]; then
                  echo "‚ö†Ô∏è  Image not found: $img"
                fi
              fi
            done <<< "$images"
          else
            echo "No images found in README.md"
          fi

  validate-code-blocks:
    name: Validate Code Blocks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check YAML code blocks
        run: |
          echo "Validating YAML code blocks in markdown files..."

          # Extract YAML code blocks and validate
          for md_file in *.md; do
            if [ -f "$md_file" ]; then
              echo "Checking $md_file..."

              # This is a simple check - extract ```yaml blocks and validate syntax
              # More sophisticated validation could use a YAML parser
              awk '/```yaml/,/```/' "$md_file" | grep -v '```' > /tmp/yaml_blocks.txt || true

              if [ -s /tmp/yaml_blocks.txt ]; then
                echo "  Found YAML blocks in $md_file"
              fi
            fi
          done

          echo "‚úÖ YAML code block validation complete"

      - name: Check for outdated references
        run: |
          echo "Checking for potentially outdated version references..."

          # Check for old year references (might indicate outdated content)
          current_year=$(date +%Y)
          old_years=$((current_year - 2))

          if grep -r "202[0-9]" *.md | grep -v "$current_year" | grep -v "$((current_year - 1))"; then
            echo "‚ö†Ô∏è  Found references to years before $old_years - content might be outdated"
          else
            echo "‚úÖ No obviously outdated year references found"
          fi

  check-claude-md:
    name: Validate CLAUDE.md
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check CLAUDE.md exists
        run: |
          if [ ! -f "CLAUDE.md" ]; then
            echo "‚ö†Ô∏è  CLAUDE.md not found - recommended for AI-assisted development"
          else
            echo "‚úÖ CLAUDE.md exists"
          fi

      - name: Validate CLAUDE.md structure
        if: hashFiles('CLAUDE.md') != ''
        run: |
          echo "Validating CLAUDE.md structure..."

          required_sections=(
            "Project Overview"
            "Project Structure"
            "Quick Reference"
          )

          for section in "${required_sections[@]}"; do
            if grep -qi "$section" CLAUDE.md; then
              echo "‚úÖ Found: $section"
            else
              echo "‚ö†Ô∏è  Missing recommended section: $section"
            fi
          done

  summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [markdown-lint, link-checker, check-readme, validate-code-blocks, check-claude-md]
    if: always()
    steps:
      - name: Documentation Check Complete
        run: |
          echo "üìö Documentation validation completed!"
          echo ""
          echo "‚úÖ Markdown Linting: ${{ needs.markdown-lint.result }}"
          echo "‚úÖ Link Checker: ${{ needs.link-checker.result }}"
          echo "‚úÖ README Validation: ${{ needs.check-readme.result }}"
          echo "‚úÖ Code Block Validation: ${{ needs.validate-code-blocks.result }}"
          echo "‚úÖ CLAUDE.md Check: ${{ needs.check-claude-md.result }}"
